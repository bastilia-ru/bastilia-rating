@page "/project/{projectId}"
@using Bastilia.Rating.Portal.Components.BastiliaUsers
@using Microsoft.AspNetCore.Components.QuickGrid

@inject IBastiliaProjectRepository Repository
@inject NavigationManager NavigationManager
<PageTitle>Проект @project?.ProjectName</PageTitle>
@if (project is null || pmaItems is null)
{
    <LoadingSpinner />
    return;
}
<ProjectCard Project="project" />
@if (project.ProjectMemberAchievements.Count > 0)
{

    <QuickGrid Items="pmaItems" Class="table table-striped" Virtualize="false">
        <TemplateColumn Context="item" Title="Имя" SortBy="@usernameSort">
            <BastiliaUserLink  Member="@item.User"/>
        </TemplateColumn>
        <PropertyColumn Property="i => i.Name" Title="Достижение">
        </PropertyColumn>
        <PropertyColumn Property="i => i.Value" Title="Рейтинг" IsDefaultSortColumn="true" Sortable="true" InitialSortDirection="SortDirection.Descending">
        </PropertyColumn>
        <PropertyColumn Property="i =>i.Expired" Title="Истекло" />
    </QuickGrid>
}

@code {
    [Parameter]
    public string? ProjectId { get; set; }

    private BastiliaProjectWithDetails? project;
    private IQueryable<ProjectMemberAchievement>? pmaItems;

    private GridSort<ProjectMemberAchievement> usernameSort = GridSort<ProjectMemberAchievement>.ByDescending(x => x.User.UserName);

    protected override async Task OnParametersSetAsync()
    {
        if (int.TryParse(ProjectId, out var projectId))
        {
            project = await Repository.GetByIdAsync(projectId);
        }
        else
        {
            project = await Repository.GetBySlugAsync(ProjectId);
        }

        if (project is null)
        {
            NavigationManager.NavigateTo("/404");
        }
        else {
            pmaItems = project.ProjectMemberAchievements.AsQueryable();
        }
    }
}
